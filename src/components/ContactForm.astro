---
interface InputsData {
  question: string;
  type: 'text' | 'email' | 'tel' | 'textarea';
  id: string;
  placeholder: string;
  pattern?: string;
  required: boolean;
}

const INPUTS: InputsData[] = [
  {
    question: 'Nombre*',
    type: 'text',
    id: 'name',
    placeholder: 'Introduce tu nombre',
    required: true,
  },
  {
    question: 'Apellido',
    type: 'text',
    id: 'surname',
    placeholder: 'Introduce tu apellido',
    required: false,
  },
  {
    question: 'Email*',
    type: 'email',
    id: 'email',
    placeholder: 'Introduce tu email',
    required: true,
  },
  {
    question: 'Teléfono',
    type: 'tel',
    id: 'phone',
    placeholder: 'Introduce tu teléfono',
    pattern: '^(\+?\d{1,3}\s*)?(\s*\d\s*){9}$',
    required: false,
  },
];
---

<form class="space-y-6" autocomplete="on">
  <div class="grid grid-cols-1 gap-6 md:grid-cols-2">
    {
      INPUTS.map(input => (
        <div
          class={`text-gray-900 ${input.type === 'textarea' ? 'col-span-full' : ''}`}
        >
          <label
            for={input.id}
            class="mb-2 block text-xl font-bold text-primary"
          >
            {input.question}
          </label>

          <input
            type={input.type}
            id={input.id}
            name={input.id}
            placeholder={input.placeholder}
            required={input.required}
            class="w-full border-b border-gray-300 pt-4 pb-2 placeholder:font-semibold focus:border-primary/70 focus:outline-none"
            pattern={input.pattern ? input.pattern : undefined}
          />
        </div>
      ))
    }
    <div class="col-span-full text-gray-900">
      <label for="message" class="mb-2 block text-xl font-bold text-primary"
        >Tu mensaje*</label
      >
      <textarea
        id="message"
        name="message"
        placeholder="Cuéntanos más sobre tu viaje ideal..."
        class="field-sizing-content min-h-32 w-full border-b border-gray-300 pt-4 pb-2 placeholder:font-semibold focus:border-primary/70 focus:outline-none"
        required></textarea>
    </div>
  </div>

  <div class="flex items-center">
    <input
      id="privacy"
      name="privacy"
      type="checkbox"
      class="size-4 rounded border border-gray-600 text-primary"
      required
    />
    <label for="privacy" class="ml-2 block text-sm text-gray-600">
      Acepto la <a
        href="/politica-de-privacidad-y-cookies"
        class="text-primary hover:underline">política de privacidad</a
      > y el tratamiento de mis datos
    </label>
  </div>

  <button
    type="submit"
    class="w-full rounded-xl bg-primary px-4 py-3 font-bold text-white transition duration-300 hover:bg-primary/90"
  >
    Enviar Consulta
  </button>
</form>

<script>
  const form = document.querySelector('form');
  const CONTACT_ENDPOINT = import.meta.env.PUBLIC_CONTACT_FORM_ENDPOINT;

  form?.addEventListener('submit', async event => {
    event.preventDefault();

    const formData = new FormData(form);
    const data = Object.fromEntries(formData);

    // Deshabilitar botón para evitar envíos múltiples
    const submitButton: HTMLButtonElement | null = form.querySelector(
      'button[type="submit"]'
    );
    const originalText = submitButton?.textContent || 'Enviar Consulta';

    if (submitButton) {
      submitButton.disabled = true;
      submitButton.textContent = 'Enviando...';
    }

    try {
      const response = await fetch(CONTACT_ENDPOINT, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });

      if (response.ok) {
        alert('Mensaje enviado con éxito. Revisa tu email.');
        form.reset();
      } else {
        const errorData = await response.json().catch(() => ({}));
        console.error('Error del servidor:', errorData);
        alert(
          'Ha ocurrido un error al enviar el formulario. Por favor, inténtalo de nuevo o contáctanos por teléfono.'
        );
      }
    } catch (error) {
      console.error('Error de red:', error);
      alert(
        'Error de conexión. Por favor, verifica tu conexión a internet e inténtalo de nuevo.'
      );
    } finally {
      // Rehabilitar botón
      if (submitButton) {
        submitButton.disabled = false;
        submitButton.textContent = originalText;
      }
    }
  });
</script>
