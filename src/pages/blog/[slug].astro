---
import { Image } from 'astro:assets';
import { getCollection, type CollectionEntry } from 'astro:content';
import Layout from '@/layouts/Layout.astro';
import CTA from '@/components/Cta.astro';
import Breadcrumbs from '@/components/Breadcrumbs.astro';
import {
  getArticleSchema,
  getBlogCombinedSchema,
  getFAQSchema,
  type BreadcrumbItem,
} from '@/config/schemas';
import BlogCard from '@/components/blog/BlogEntryCard.astro';
import '@/styles/prose.css';

interface Props {
  post: CollectionEntry<'blog'>;
}

export async function getStaticPaths() {
  const posts: CollectionEntry<'blog'>[] = await getCollection('blog');
  return posts.map(post => ({
    params: { slug: post.id.replace('.md', '') },
    props: { post },
  }));
}

const { post } = Astro.props;
const { Content } = await post.render();

const relatedPosts = await getCollection('blog', ({ data }) => {
  return data.destinations?.some(destination =>
    post.data.destinations?.includes(destination)
  );
});

const sortedRelatedPosts = relatedPosts
  .filter(p => p.id !== post.id)
  .sort(
    (a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime()
  );

const title = `${post.data.title} | Kilómetros por Explorar`;
const description = post.data.description;
const pathname = Astro.url.pathname;

const breadcrumbItems: BreadcrumbItem[] = [
  { name: 'Inicio', href: '/' },
  { name: 'Blog', href: '/blog' },
  { name: post.data.title },
];

const mainDestination = post.data.destinations?.[0];

const articleSchema = getArticleSchema(
  post.data.title,
  description,
  pathname,
  post.data.date.toISOString(),
  undefined,
  post.data.image,
  post.data.author,
  mainDestination
);

const faqSchema = getFAQSchema(post.data.faqs);

const schema = getBlogCombinedSchema(articleSchema, breadcrumbItems, faqSchema);
---

<Layout title={title} description={description} schema={schema}>
  <main id="main" class="bg-white pt-20">
    <!-- Breadcrumbs -->
    <div class="mx-auto max-w-5xl py-4">
      <Breadcrumbs items={breadcrumbItems} includeSchema={false} />
    </div>

    <!-- Hero image -->
    <div class="mx-auto w-full max-w-5xl">
      <Image
        width="1200"
        height="600"
        src={post.data.image}
        alt={post.data.title}
        class="h-[240px] w-full object-cover md:h-[420px]"
        loading="eager"
      />
    </div>

    <!-- Content -->
    <div
      class="relative z-10 mx-auto -mt-12 max-w-4xl bg-white px-4 sm:px-6 md:-mt-16 lg:-mt-20 lg:px-8"
    >
      <!-- Header -->
      <header class="mb-8 pt-8 text-center md:pt-12">
        <div
          class="mb-4 flex flex-wrap items-center justify-center gap-4 text-neutral-600"
        >
          <span class="capitalize">{post.data.author}</span>
          <span> | </span>
          <time datetime={post.data.date.toISOString()}>
            {
              post.data.date.toLocaleDateString('es-ES', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
              })
            }
          </time>
        </div>
        <h1 class="text-3xl font-bold text-gray-900 md:text-4xl">
          {post.data.title}
        </h1>
      </header>

      <hr class="my-8 border-t border-gray-300 lg:my-16" />

      <!-- Article -->
      <article class="mx-auto prose mb-12 max-w-[800px] lg:prose-lg">
        <Content />
      </article>

      <hr class="my-8 border-t border-gray-300 lg:my-16" />
    </div>

    <!-- Related articles -->
    {
      sortedRelatedPosts.length > 0 && (
        <div class="mx-auto mb-16 max-w-4xl px-4 sm:px-6 lg:px-8">
          <h2 class="mb-6 text-2xl font-bold text-gray-900">
            Artículos relacionados
          </h2>
          <div class="grid gap-8 md:grid-cols-2">
            {sortedRelatedPosts.map(post => (
              <BlogCard post={post} loading="lazy" />
            ))}
          </div>
        </div>
      )
    }
    <CTA />
  </main>
</Layout>
