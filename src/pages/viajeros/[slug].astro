---
import { Image } from 'astro:assets';
import { getCollection, type CollectionEntry } from 'astro:content';
import {
  getWebPageSchema,
  getOrganizationSchema,
  getWebSiteSchema,
  getBreadcrumbSchema,
  type BreadcrumbItem,
} from '@/config/schemas';
import Layout from '@/layouts/Layout.astro';
import CustomerTimeline from '@/components/customers/CustomerTimeline.astro';
import Breadcrumbs from '@/components/Breadcrumbs.astro';
import Cta from '@/components/Cta.astro';
import '@/styles/prose.css';

interface Props {
  customer: CollectionEntry<'customers'>;
}

export async function getStaticPaths() {
  const customers = await getCollection('customers');
  return customers.map(customer => ({
    params: { slug: customer.id.replace('.md', '') },
    props: { customer },
  }));
}

const { customer } = Astro.props;
const { Content } = await customer.render();

const title = `Descubre la Aventura de ${customer.data.name} | Kil√≥metros por Explorar`;
const description = customer.data.title;

const breadcrumbItems: BreadcrumbItem[] = [
  { name: 'Inicio', href: '/' },
  { name: 'Viajeros', href: '/viajeros' },
  { name: customer.data.name },
];

const pathname = Astro.url.pathname;
const pageSchema = getWebPageSchema(title, description, pathname);
const schema = {
  '@context': 'https://schema.org',
  '@graph': [
    getOrganizationSchema(),
    getWebSiteSchema(),
    pageSchema,
    getBreadcrumbSchema(breadcrumbItems),
  ],
};
---

<Layout title={title} description={description} schema={schema}>
  <!-- Hero Section -->
  <section
    id="hero"
    class="relative z-10 mx-auto max-w-6xl overflow-hidden px-4 pt-24 lg:px-8"
  >
    <!-- Breadcrumb -->
    <Breadcrumbs items={breadcrumbItems} class="mb-6" includeSchema={false} />

    <!-- Customer flag -->
    <div class="mb-6">
      <img
        src={customer.data.destinationFlagImage}
        alt={`Bandera de ${customer.data.destination}`}
        width={300}
        height={150}
        class="h-12 w-auto object-contain"
        loading="eager"
      />
    </div>

    <!-- Hero Title -->
    <h1
      class="mb-10 text-3xl font-bold text-gray-900 md:text-[42px] md:leading-14 lg:mb-18 lg:text-5xl"
    >
      {customer.data.title}
    </h1>

    <!-- Key Metrics -->
    <div class="mb-8 grid grid-cols-2 gap-6 md:grid-cols-4">
      {
        customer.data.metrics.map((metric, index) => (
          <div
            class={`flex flex-col items-center justify-center md:p-4 ${index < 3 ? 'md:border-r md:border-gray-100' : ''}`}
          >
            <span class="mb-2 bg-gradient-to-b from-blue-700 to-primary bg-clip-text font-blimone text-3xl font-bold text-transparent md:text-5xl">
              {metric.value}
            </span>
            <p class="text-center text-lg text-gray-600">{metric.label}</p>
          </div>
        ))
      }
    </div>

    <!-- Image -->
    <div class="relative mt-18 overflow-hidden shadow-lg lg:mx-3">
      <Image
        src={customer.data.image}
        alt={`Foto del viaje de ${customer.data.name}`}
        width={800}
        height={600}
        class="max-h-[600px] w-full object-cover"
        loading="eager"
      />
    </div>
  </section>

  <!-- Timeline Section-->
  <section class="mx-auto max-w-7xl px-4 pt-12 md:pt-16 lg:px-8">
    <div class="mx-auto flex max-w-4xl flex-col gap-12 lg:flex-row-reverse">
      <div class="px-4">
        <CustomerTimeline
          description={customer.data.description}
          destination={customer.data.destination}
        />
      </div>
    </div>
  </section>

  <!-- Content Section -->
  <section class="mx-auto max-w-4xl px-4 py-8">
    <hr class="mb-8 border-t border-gray-200 lg:mb-16" />
    <article class="prose max-w-none text-gray-800 md:prose-lg lg:prose-xl">
      <Content />
    </article>
    <hr class="mt-8 border-t border-gray-200 lg:mt-16" />
  </section>

  <Cta />
</Layout>
